{% extends 'shared/layout.html' %} 
{% load static %} 
{% load humanize %} 
{% load mathfilters %} 

{% block title %}Estadísticas{% endblock %} 
{% block content %}
<div class="w-full max-w-screen-2xl mx-auto px-4">
  <!-- Header Card -->
  <div class="bg-white rounded-xl shadow-lg overflow-hidden mb-6 w-full">
    <div class="gradient-header px-6 py-4">
      <div class="flex items-center justify-between flex-wrap gap-4">
        <div class="flex items-center space-x-3">
          <div class="bg-white rounded-full p-2">
            <i class="fas fa-chart-simple icon-institucional text-2xl"></i>
          </div>
          <h1 class="text-2xl font-bold text-white">Estadísticas</h1>
        </div>
      </div>
    </div>

    <!-- Contenedor de búsqueda y tabla -->
    <div class="p-6">
      <!-- Barra superior con buscador -->
      <div
        class="flex flex-col sm:flex-row justify-between items-center gap-4 mb-4"
      >
        <!-- Buscador -->
        <div class="search-container mb-0 flex-1">
          <div class="relative">
            <i class="fas fa-search search-icon"></i>
            <input
              type="text"
              id="searchInput"
              class="search-input"
              placeholder="Buscar por nombre o identificación..."
            />
          </div>
        </div>
      </div>

      <!-- Tabla -->
      <div class="custom-table-container">
        <table class="custom-table" id="estadisticasTable">
          <thead>
            <tr>
              <th class="sortable" data-column="0" data-type="text">
                Identificación
                <span class="sort-icon">
                  <i class="fas fa-caret-up"></i>
                  <i class="fas fa-caret-down"></i>
                </span>
              </th>
              <th class="sortable" data-column="1" data-type="text">
                Nombres
                <span class="sort-icon">
                  <i class="fas fa-caret-up"></i>
                  <i class="fas fa-caret-down"></i>
                </span>
              </th>
              <th class="sortable" data-column="2" data-type="text">
                Apellidos
                <span class="sort-icon">
                  <i class="fas fa-caret-up"></i>
                  <i class="fas fa-caret-down"></i>
                </span>
              </th>
              <th class="sortable" data-column="3" data-type="text">
                Municipio
                <span class="sort-icon">
                  <i class="fas fa-caret-up"></i>
                  <i class="fas fa-caret-down"></i>
                </span>
              </th>
              <th class="sortable" data-column="4" data-type="date">
                Último registro
                <span class="sort-icon">
                  <i class="fas fa-caret-up"></i>
                  <i class="fas fa-caret-down"></i>
                </span>
              </th>
              <th class="sortable" data-column="5" data-type="number">
                Meta electoral
                <span class="sort-icon">
                  <i class="fas fa-caret-up"></i>
                  <i class="fas fa-caret-down"></i>
                </span>
              </th>
              <th class="sortable" data-column="6" data-type="number">
                Registrados
                <span class="sort-icon">
                  <i class="fas fa-caret-up"></i>
                  <i class="fas fa-caret-down"></i>
                </span>
              </th>
              <th class="sortable" data-column="7" data-type="number">
                Zonificados
                <span class="sort-icon">
                  <i class="fas fa-caret-up"></i>
                  <i class="fas fa-caret-down"></i>
                </span>
              </th>
              <th class="sortable" data-column="8" data-type="number">
                Asistieron
                <span class="sort-icon">
                  <i class="fas fa-caret-up"></i>
                  <i class="fas fa-caret-down"></i>
                </span>
              </th>
              <th class="sortable" data-column="9" data-type="number">
                Pendientes
                <span class="sort-icon">
                  <i class="fas fa-caret-up"></i>
                  <i class="fas fa-caret-down"></i>
                </span>
              </th>
              <th class="text-center">
                Acciones
              </th>
            </tr>
          </thead>
          <tbody>
            {% for item in estadisticas %}
            <tr data-usuario-id="{{ item.id }}">
              <td class="text-center">{{ item.identificacion }}</td>
              <td class="text-center">{{ item.nombres }}</td>
              <td class="text-center">{{ item.apellidos }}</td>
              <td class="text-center">{{ item.municipio }}</td>
              <td
                class="text-center"
                data-timestamp="{% if item.ultimo_registro %}{{ item.ultimo_registro|date:'U' }}{% else %}0{% endif %}"
              >
                {{ item.ultimo_registro|date:"d/m/Y H:i"|default_if_none:"N/A" }}
              </td>
              <td class="text-center" data-value="{{ item.meta }}">
                {{ item.meta }}
              </td>
              <td class="text-center" data-value="{{ item.registrados }}">
                {{ item.registrados }}
              </td>
              <td class="text-center" data-value="{{ item.zonificados }}">
                {{ item.zonificados }}
              </td>
              <td class="text-center" data-value="{{ item.asistieron }}">
                {{ item.asistieron }}
              </td>
              <td class="text-center" data-value="{{ item.pendientes }}">
                {% if item.pendientes > item.media %}
                <span class="badge-danger">{{ item.pendientes }}</span>
                {% elif item.pendientes > 0 and item.pendientes <= item.media %}
                <span class="badge-warning">{{ item.pendientes }}</span>
                {% elif item.pendientes == 0 %}
                <span class="badge-success">{{ item.pendientes }}</span>
                {% elif item.pendientes < 0 %}
                <span class="badge-success">+{{ item.pendientes|abs }}</span>
                {% endif %}
              </td>
              <td class="text-center">
                <button 
                  onclick="verDetalleUsuario('{{ item.id }}')"
                  class="inline-flex items-center px-3 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors duration-200 shadow-sm hover:shadow-md text-sm">
                  <i class="fas fa-eye mr-2"></i>
                  Ver detallado
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Mensaje cuando no hay resultados -->
      <div id="noResults" class="hidden text-center py-8 text-gray-500">
        <i class="fas fa-search text-4xl mb-3 text-gray-300"></i>
        <p class="text-lg font-medium">No se encontraron resultados</p>
        <p class="text-sm">Intenta con otro término de búsqueda</p>
      </div>
    </div>
  </div>

  <!-- Info Cards en Grid -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <!-- Card Info Total -->
    <div class="alert-institucional rounded-lg p-4 shadow-md">
      <div class="flex items-start space-x-3">
        <i class="fas fa-users icon-institucional text-xl mt-0.5"></i>
        <div>
          <p class="text-sm text-gray-800">
            <span class="font-semibold">Meta electoral:</span>
            <span class="text-lg font-bold" id="totalCount"
              >{{ meta_electoral|intcomma }}</span
            >
          </p>
        </div>
      </div>
    </div>

    <div
      class="bg-purple-50 border-l-4 border-purple-400 rounded-lg p-4 shadow-md"
    >
      <div class="flex items-start space-x-3">
        <i class="fas fa-filter text-purple-500 text-xl mt-0.5"></i>
        <div>
          <p class="text-sm text-purple-800">
            <span class="font-semibold">Total personas registradas:</span>
            <span class="text-lg font-bold" id="visibleCount"
              >{{ total_registrados|intcomma }}</span
            >
          </p>
        </div>
      </div>
    </div>

    <!-- Card Leyenda -->
    <div
      class="bg-green-50 border-l-4 border-green-400 rounded-lg p-4 shadow-md"
    >
      <div class="flex items-start space-x-3">
        <i class="fas fa-info-circle text-green-500 text-xl mt-0.5"></i>
        <div class="text-sm text-green-800">
          <p class="font-semibold mb-1">Leyenda:</p>
          <p>
            <span class="badge-success text-xs">Verde</span> = Meta cumplida
          </p>
          <p>
            <span class="badge-warning text-xs">Amarillo</span> = Debajo de la
            media
          </p>
          <p><span class="badge-danger text-xs">Rojo</span> = Muy por debajo</p>
        </div>
      </div>
    </div>

    <div class="bg-blue-50 border-l-4 border-blue-400 rounded-lg p-4 shadow-md">
    <div class="flex items-start space-x-3">
        <i class="fas fa-map-marker-alt text-blue-500 text-xl mt-0.5"></i>
        <div class="w-full">
            <p class="text-sm font-semibold text-blue-800 mb-2">Total Personas por Municipio</p>
            <div class="overflow-auto">
                <table class="w-full table-auto">
                    <tbody class="divide-y divide-transparent">
                        {% for municipio in municipios %}
                        <tr>
                            <td class="text-sm text-blue-800 w-1/2">{{ municipio.nom_municipio }}:</td>
                            <td class="text-sm text-blue-800 font-bold">
                                {{ municipio.registrados|intcomma }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
  </div>

  <!-- Modal para Ver Detalle de Metas -->
  <div id="modalDetalleMetas" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-4xl shadow-lg rounded-xl bg-white">
      <!-- Header del Modal -->
      <div class="gradient-header px-6 py-4 rounded-t-xl">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-3">
            <div class="bg-white rounded-full p-2">
              <i class="fas fa-chart-line icon-institucional text-xl"></i>
            </div>
            <h3 class="text-xl font-bold text-white">Detalle de Metas Electorales</h3>
          </div>
          <button onclick="cerrarModal()" class="text-white hover:text-gray-200 transition-colors">
            <i class="fas fa-times text-2xl"></i>
          </button>
        </div>
      </div>

      <!-- Contenido del Modal -->
      <div class="p-6">
        <!-- Información del Usuario -->
        <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg p-4 mb-4 border border-blue-100">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <p class="text-sm text-gray-600 font-medium">Identificación</p>
              <p class="text-lg font-bold text-gray-800" id="modalIdentificacion">-</p>
            </div>
            <div>
              <p class="text-sm text-gray-600 font-medium">Nombres</p>
              <p class="text-lg font-bold text-gray-800" id="modalNombres">-</p>
            </div>
            <div>
              <p class="text-sm text-gray-600 font-medium">Apellidos</p>
              <p class="text-lg font-bold text-gray-800" id="modalApellidos">-</p>
            </div>
          </div>
        </div>

        <!-- Loading -->
        <div id="modalLoading" class="text-center py-8">
          <i class="fas fa-spinner fa-spin text-4xl text-blue-500"></i>
          <p class="mt-2 text-gray-600">Cargando información...</p>
        </div>

        <!-- Tabla de Metas -->
        <div id="modalTablaContainer" class="hidden">
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
                <tr>
                  <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">
                    <i class="fas fa-map-marker-alt mr-2"></i>Departamento
                  </th>
                  <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">
                    <i class="fas fa-city mr-2"></i>Municipio
                  </th>
                  <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">
                    <i class="fas fa-location-dot mr-2"></i>Puesto
                  </th>
                  <th class="px-6 py-4 text-center text-xs font-bold text-gray-700 uppercase tracking-wider">
                    <i class="fas fa-bullseye mr-2"></i>Meta
                  </th>
                  <th class="px-6 py-4 text-center text-xs font-bold text-gray-700 uppercase tracking-wider">
                    <i class="fas fa-users mr-2"></i>Registrados
                  </th>
                  <th class="px-6 py-4 text-center text-xs font-bold text-gray-700 uppercase tracking-wider">
                    <i class="fas fa-percentage mr-2"></i>Cumplimiento
                  </th>
                </tr>
              </thead>
              <tbody id="modalMetasBody" class="bg-white divide-y divide-gray-200">
                <!-- Se llenará dinámicamente con JavaScript -->
              </tbody>
            </table>
          </div>

          <!-- Resumen -->
          <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg px-4 py-3 border border-blue-200">
              <p class="text-sm text-gray-600 mb-1">Total Meta</p>
              <p class="text-2xl font-bold text-gray-800" id="modalTotalMeta">0</p>
            </div>
            <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg px-4 py-3 border border-green-200">
              <p class="text-sm text-gray-600 mb-1">Total Registrados</p>
              <p class="text-2xl font-bold text-gray-800" id="modalTotalRegistrados">0</p>
            </div>
            <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg px-4 py-3 border border-purple-200">
              <p class="text-sm text-gray-600 mb-1">Cumplimiento General</p>
              <p class="text-2xl font-bold text-gray-800" id="modalCumplimientoGeneral">0%</p>
            </div>
          </div>
        </div>

        <!-- Error Message -->
        <div id="modalError" class="hidden text-center py-8">
          <i class="fas fa-exclamation-circle text-4xl text-red-500"></i>
          <p class="mt-2 text-red-600 font-medium">Error al cargar la información</p>
          <p class="text-sm text-gray-500" id="modalErrorMessage">Intenta nuevamente</p>
        </div>
      </div>

      <!-- Footer del Modal -->
      <div class="bg-gray-50 px-6 py-4 rounded-b-xl">
        <button 
          onclick="cerrarModal()"
          class="w-full sm:w-auto px-6 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors duration-200">
          <i class="fas fa-times mr-2"></i>Cerrar
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  // Sistema de búsqueda y ordenamiento (sin paginación)
  document.addEventListener("DOMContentLoaded", function () {
    const searchInput = document.getElementById("searchInput");
    const table = document.getElementById("estadisticasTable");
    const tbody = table.querySelector("tbody");
    const allRows = Array.from(tbody.querySelectorAll("tr"));
    const noResults = document.getElementById("noResults");
    const tableContainer = table.parentElement;
    const visibleCount = document.getElementById("visibleCount");

    // Elementos de ordenamiento
    const sortableHeaders = table.querySelectorAll("th.sortable");

    let filteredRows = [...allRows];
    let currentSort = { column: null, direction: null };

    // ✅ AJUSTE: Orden asc/desc corregido
    function sortRows(columnIndex, dataType) {
      const headers = Array.from(sortableHeaders);
      const clickedHeader = headers.find(
        (h) => parseInt(h.dataset.column) === columnIndex
      );

      // Alternar dirección (solo asc/desc)
      if (currentSort.column === columnIndex) {
        currentSort.direction =
          currentSort.direction === "asc" ? "desc" : "asc";
      } else {
        currentSort.column = columnIndex;
        currentSort.direction = "asc";
      }

      // Actualizar clases visuales
      headers.forEach((h) => h.classList.remove("sort-asc", "sort-desc"));
      clickedHeader.classList.add(`sort-${currentSort.direction}`);

      // Ordenar las filas filtradas
      filteredRows.sort((a, b) => {
        let aValue, bValue;

        if (dataType === "date") {
          const aCells = a.querySelectorAll("td");
          const bCells = b.querySelectorAll("td");
          aValue =
            parseInt(aCells[columnIndex].dataset.timestamp || "0", 10) || 0;
          bValue =
            parseInt(bCells[columnIndex].dataset.timestamp || "0", 10) || 0;
        } else if (dataType === "number") {
          const aCells = a.querySelectorAll("td");
          const bCells = b.querySelectorAll("td");
          aValue = parseFloat(aCells[columnIndex].dataset.value) || 0;
          bValue = parseFloat(bCells[columnIndex].dataset.value) || 0;
        } else {
          const aCells = a.querySelectorAll("td");
          const bCells = b.querySelectorAll("td");
          aValue = aCells[columnIndex].textContent.trim().toLowerCase();
          bValue = bCells[columnIndex].textContent.trim().toLowerCase();

          const aNum = parseFloat(aValue.replace(/\./g, "").replace(",", "."));
          const bNum = parseFloat(bValue.replace(/\./g, "").replace(",", "."));
          if (!isNaN(aNum) && !isNaN(bNum)) {
            aValue = aNum;
            bValue = bNum;
          }
        }

        if (aValue < bValue) return currentSort.direction === "asc" ? -1 : 1;
        if (aValue > bValue) return currentSort.direction === "asc" ? 1 : -1;
        return 0;
      });

      // ✅ Reinsertar las filas ordenadas al tbody
      tbody.innerHTML = "";
      filteredRows.forEach((row) => tbody.appendChild(row));

      renderTable();
    }

    // Event listeners para headers ordenables
    sortableHeaders.forEach((header) => {
      header.addEventListener("click", function () {
        const columnIndex = parseInt(this.dataset.column);
        const dataType = this.dataset.type;
        sortRows(columnIndex, dataType);
      });
    });

    // Función para renderizar la tabla
    function renderTable() {
      allRows.forEach((row) => (row.style.display = "none"));
      filteredRows.forEach((row) => (row.style.display = ""));

      if (filteredRows.length === 0) {
        tableContainer.classList.add("hidden");
        noResults.classList.remove("hidden");
        visibleCount.textContent = "0";
      } else {
        tableContainer.classList.remove("hidden");
        noResults.classList.add("hidden");
        //visibleCount.textContent = filteredRows.length;
      }
    }

    // Búsqueda
    searchInput.addEventListener("keyup", function () {
      const searchTerm = this.value.toLowerCase().trim();

      filteredRows = allRows.filter((row) => {
        const text = row.textContent.toLowerCase();
        return text.includes(searchTerm);
      });

      // Mantener orden actual si lo hay
      if (currentSort.column !== null && currentSort.direction) {
        sortRows(
          currentSort.column,
          sortableHeaders[currentSort.column].dataset.type
        );
      } else {
        renderTable();
      }
    });

    // Render inicial
    renderTable();
  });

  // Función para abrir el modal y cargar datos del usuario
  function verDetalleUsuario(usuarioId) {
    const modal = document.getElementById('modalDetalleMetas');
    const loading = document.getElementById('modalLoading');
    const tablaContainer = document.getElementById('modalTablaContainer');
    const errorDiv = document.getElementById('modalError');
    
    // Mostrar modal y loading
    modal.classList.remove('hidden');
    loading.classList.remove('hidden');
    tablaContainer.classList.add('hidden');
    errorDiv.classList.add('hidden');
    
    // Obtener datos del usuario de la fila de la tabla
    const tabla = document.getElementById('estadisticasTable');
    const filas = tabla.querySelectorAll('tbody tr');
    let datosUsuario = null;
    
    filas.forEach(fila => {
      const dataUsuarioId = fila.getAttribute('data-usuario-id');
      if (dataUsuarioId == usuarioId) {
        const celdas = fila.querySelectorAll('td');
        datosUsuario = {
          identificacion: celdas[0].textContent.trim(),
          nombres: celdas[1].textContent.trim(),
          apellidos: celdas[2].textContent.trim()
        };
      }
    });
    
    // Actualizar información del usuario en el modal
    if (datosUsuario) {
      document.getElementById('modalIdentificacion').textContent = datosUsuario.identificacion;
      document.getElementById('modalNombres').textContent = datosUsuario.nombres;
      document.getElementById('modalApellidos').textContent = datosUsuario.apellidos;
    }
    
    // Realizar petición AJAX
    fetch(`/usuarios/get_metas/${usuarioId}/`)
      .then(response => {
        if (!response.ok) {
          throw new Error('Error en la respuesta del servidor');
        }
        return response.json();
      })
      .then(data => {
        loading.classList.add('hidden');
        
        if (data.length === 0) {
          errorDiv.classList.remove('hidden');
          document.getElementById('modalErrorMessage').textContent = 'Este usuario no tiene metas asignadas';
        } else {
          tablaContainer.classList.remove('hidden');
          cargarMetasEnTabla(data);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        loading.classList.add('hidden');
        errorDiv.classList.remove('hidden');
        document.getElementById('modalErrorMessage').textContent = error.message;
      });
  }
  
  // Función para llenar la tabla con las metas
  function cargarMetasEnTabla(metas) {
    const tbody = document.getElementById('modalMetasBody');
    tbody.innerHTML = '';
    
    let totalMeta = 0;
    let totalRegistrados = 0;
    
    metas.forEach(meta => {
      totalMeta += meta.meta;
      totalRegistrados += meta.registrados;
      
      const cumplimiento = meta.meta > 0 ? ((meta.registrados / meta.meta) * 100).toFixed(1) : 0;
      
      const tr = document.createElement('tr');
      tr.className = 'hover:bg-gray-50 transition-colors duration-150';
      tr.innerHTML = `
        <td class="px-6 py-4 whitespace-nowrap">
          <div class="text-sm font-medium text-gray-900">${meta.departamento}</div>
        </td>
        <td class="px-6 py-4 whitespace-nowrap">
          <div class="text-sm font-medium text-gray-900">${meta.municipio}</div>
        </td>
        <td class="px-6 py-4 whitespace-nowrap">
          <div class="text-sm text-gray-900">${meta.puesto}</div>
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-center">
          <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold bg-blue-100 text-blue-800">
            <i class="fas fa-flag-checkered mr-2"></i>${meta.meta}
          </span>
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-center">
          <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold bg-green-100 text-green-800">
            <i class="fas fa-users mr-2"></i>${meta.registrados}
          </span>
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-center">
          <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold ${getCumplimientoClass(cumplimiento)}">
            ${cumplimiento}%
          </span>
        </td>
      `;
      tbody.appendChild(tr);
    });
    
    // Actualizar resumen
    const cumplimientoGeneral = totalMeta > 0 ? ((totalRegistrados / totalMeta) * 100).toFixed(1) : 0;
    document.getElementById('modalTotalMeta').textContent = totalMeta.toLocaleString();
    document.getElementById('modalTotalRegistrados').textContent = totalRegistrados.toLocaleString();
    document.getElementById('modalCumplimientoGeneral').textContent = cumplimientoGeneral + '%';
  }
  
  // Función para obtener la clase CSS según el porcentaje de cumplimiento
  function getCumplimientoClass(porcentaje) {
    if (porcentaje >= 100) {
      return 'bg-green-100 text-green-800';
    } else if (porcentaje >= 75) {
      return 'bg-yellow-100 text-yellow-800';
    } else if (porcentaje >= 50) {
      return 'bg-orange-100 text-orange-800';
    } else {
      return 'bg-red-100 text-red-800';
    }
  }
  
  // Función para cerrar el modal
  function cerrarModal() {
    const modal = document.getElementById('modalDetalleMetas');
    modal.classList.add('hidden');
  }
  
  // Cerrar modal al hacer clic fuera de él
  document.getElementById('modalDetalleMetas')?.addEventListener('click', function(e) {
    if (e.target === this) {
      cerrarModal();
    }
  });
</script>
{% endblock %}